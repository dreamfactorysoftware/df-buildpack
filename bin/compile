#!/bin/sh
set -e

echo "-----> Running DreamFactory Buildpack"

# Check if BUILD_DIR is defined
if [ -z "$BUILD_DIR" ]; then
    echo "X ERROR: BUILD_DIR is not set!"
    exit 1
fi

# Install Git if missing
if ! command -v git >/dev/null 2>&1; then
    echo "X Git is missing! Installing now..."
    apt-get update && apt-get install -y git
    echo "Git installed!"
else
    echo "Git is already installed"
fi

echo "-----> Cloning DreamFactory source code"
git clone -b develop https://github.com/dreamfactorysoftware/dreamfactory.git $BUILD_DIR/dreamfactory

echo "-----> Moving DreamFactory into the Build Directory"
cp -R $BUILD_DIR/dreamfactory/. $BUILD_DIR/
rm -rf $BUILD_DIR/dreamfactory

echo "-----> Installing Composer"
curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

echo "-----> Modifying composer.json for Heroku compatibility"
cd $BUILD_DIR
# Remove packages that require unavailable extensions
composer remove --no-update \
    dreamfactory/df-hadoop \
    yajra/laravel-oci8 \
    yajra/laravel-pdo-via-oci8

# Add platform config to ignore missing extensions
composer config platform.ext-odbc false
composer config platform.ext-oci8 false

echo "-----> Running Composer Install"
composer install --no-dev --ignore-platform-reqs --optimize-autoloader

echo "-----> Running database migrations"
php artisan migrate --force

echo "-----> Setting up Nginx and PHP-FPM"
mkdir -p $BUILD_DIR/nginx
mkdir -p $BUILD_DIR/php-fpm

