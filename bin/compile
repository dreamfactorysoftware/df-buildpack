#!/bin/sh
set -e

BUILD_DIR=$1  # First argument is the build directory
CACHE_DIR=$2  # Second argument is the cache directory
ENV_DIR=$3    # Third argument is the env directory

echo "-----> Running DreamFactory Buildpack"

# Check if BUILD_DIR is defined and exists
if [ -z "$BUILD_DIR" ]; then
    echo "X ERROR: BUILD_DIR argument is not provided!"
    exit 1
fi

if [ ! -d "$BUILD_DIR" ]; then
    echo "X ERROR: BUILD_DIR ($BUILD_DIR) is not a directory!"
    exit 1
fi

echo "-----> Using BUILD_DIR: $BUILD_DIR"

echo "-----> Current directory structure before clone:"
pwd
ls -la

echo "-----> Cloning DreamFactory source code"
git clone -b develop https://github.com/dreamfactorysoftware/dreamfactory.git $BUILD_DIR/dreamfactory
echo "-----> Clone completed. Checking clone results:"
ls -la $BUILD_DIR/dreamfactory || echo "X ERROR: Clone directory not found!"

echo "-----> Moving DreamFactory into the Build Directory"
cp -R $BUILD_DIR/dreamfactory/. $BUILD_DIR/
rm -rf $BUILD_DIR/dreamfactory

# Create required directories
echo "-----> Creating required directories"
mkdir -p $BUILD_DIR/database/seeds
mkdir -p $BUILD_DIR/database/factories
mkdir -p $BUILD_DIR/storage/logs
mkdir -p $BUILD_DIR/storage/app/public
mkdir -p $BUILD_DIR/storage/framework/{cache,sessions,views}
chmod -R 775 $BUILD_DIR/storage

# Create .env file
echo "-----> Generating .env file"
cd $BUILD_DIR
php -r "copy('.env.example', '.env');"

# Let PHP buildpack handle composer installation
echo "-----> Waiting for Composer installation from PHP buildpack..."

# Create a profile.d script that will run after all buildpacks
mkdir -p $BUILD_DIR/.profile.d
cat > $BUILD_DIR/.profile.d/dreamfactory.sh <<'EOF'
#!/bin/sh

# Generate application key
php artisan key:generate --force

# Run DreamFactory environment setup
php artisan df:env --db_connection=sqlite --df_install=Cloud

# Run storage link
php artisan storage:link

# Run migrations
php artisan migrate --force
EOF

chmod +x $BUILD_DIR/.profile.d/dreamfactory.sh

echo "-----> DreamFactory buildpack complete. Handing off to PHP buildpack..."

