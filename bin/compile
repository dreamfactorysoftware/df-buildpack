#!/bin/sh
set -e

BUILD_DIR=$1  # First argument is the build directory
CACHE_DIR=$2  # Second argument is the cache directory
ENV_DIR=$3    # Third argument is the env directory

echo "-----> Running DreamFactory Buildpack"

# Check if BUILD_DIR is defined and exists
if [ -z "$BUILD_DIR" ]; then
    echo "X ERROR: BUILD_DIR argument is not provided!"
    exit 1
fi

if [ ! -d "$BUILD_DIR" ]; then
    echo "X ERROR: BUILD_DIR ($BUILD_DIR) is not a directory!"
    exit 1
fi

echo "-----> Using BUILD_DIR: $BUILD_DIR"

# Install system dependencies
echo "-----> Installing system dependencies"
apt-get update
apt-get install -y git php php-cli php-curl php-mbstring php-xml unzip

# Install Git if missing
if ! command -v git >/dev/null 2>&1; then
    echo "X Git is missing! Installing now..."
    apt-get update && apt-get install -y git
    echo "Git installed!"
else
    echo "Git is already installed"
fi

echo "-----> Current directory structure before clone:"
pwd
ls -la

echo "-----> Cloning DreamFactory source code"
git clone -b develop https://github.com/dreamfactorysoftware/dreamfactory.git $BUILD_DIR/dreamfactory
echo "-----> Clone completed. Checking clone results:"
ls -la $BUILD_DIR/dreamfactory || echo "X ERROR: Clone directory not found!"

echo "-----> Moving DreamFactory into the Build Directory"
cp -R $BUILD_DIR/dreamfactory/. $BUILD_DIR/
rm -rf $BUILD_DIR/dreamfactory

echo "-----> Checking final directory structure:"
ls -la $BUILD_DIR
echo "-----> Checking database directory:"
ls -la $BUILD_DIR/database || echo "X ERROR: Database directory not found!"

echo "-----> Installing Composer"
curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

echo "-----> Modifying composer.json for Heroku compatibility"
cd $BUILD_DIR

# Create a temporary file with jq modifications
cat > modify_composer.php <<'EOF'
<?php
$composerJson = json_decode(file_get_contents('composer.json'), true);

// Remove problematic packages
unset($composerJson['require']['dreamfactory/df-hadoop']);
unset($composerJson['require']['yajra/laravel-oci8']);
unset($composerJson['require']['yajra/laravel-pdo-via-oci8']);

// Add platform overrides
if (!isset($composerJson['config']['platform'])) {
    $composerJson['config']['platform'] = [];
}
$composerJson['config']['platform']['ext-odbc'] = false;
$composerJson['config']['platform']['ext-oci8'] = false;

file_put_contents('composer.json', json_encode($composerJson, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));
EOF

# Run the PHP script to modify composer.json
php modify_composer.php

echo "-----> Running Composer Install"
composer install --no-dev --ignore-platform-reqs --optimize-autoloader

echo "-----> Running database migrations"
php artisan migrate --force

echo "-----> Setting up Nginx and PHP-FPM"
mkdir -p $BUILD_DIR/nginx
mkdir -p $BUILD_DIR/php-fpm

