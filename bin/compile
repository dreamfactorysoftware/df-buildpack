#!/bin/sh
set -e

BUILD_DIR=$1  # First argument is the build directory
CACHE_DIR=$2  # Second argument is the cache directory
ENV_DIR=$3    # Third argument is the env directory

echo "-----> Running DreamFactory Buildpack"

# Check if BUILD_DIR is defined and exists
if [ -z "$BUILD_DIR" ]; then
    echo "X ERROR: BUILD_DIR argument is not provided!"
    exit 1
fi

if [ ! -d "$BUILD_DIR" ]; then
    echo "X ERROR: BUILD_DIR ($BUILD_DIR) is not a directory!"
    exit 1
fi

echo "-----> Using BUILD_DIR: $BUILD_DIR"

# Git should already be available in Heroku
echo "-----> Current directory structure before clone:"
pwd
ls -la

echo "-----> Cloning DreamFactory source code"
git clone -b develop https://github.com/dreamfactorysoftware/dreamfactory.git $BUILD_DIR/dreamfactory
echo "-----> Clone completed. Checking clone results:"
ls -la $BUILD_DIR/dreamfactory || echo "X ERROR: Clone directory not found!"

echo "-----> Moving DreamFactory into the Build Directory"
cp -R $BUILD_DIR/dreamfactory/. $BUILD_DIR/
rm -rf $BUILD_DIR/dreamfactory

echo "-----> Checking final directory structure:"
ls -la $BUILD_DIR
echo "-----> Checking database directory:"
ls -la $BUILD_DIR/database || echo "X ERROR: Database directory not found!"

# Let the PHP buildpack handle composer installation and PHP setup
echo "-----> DreamFactory buildpack complete. Handing off to PHP buildpack..."

